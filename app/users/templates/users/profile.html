{% extends "base.html" %}
{% load static %}
{% block title %}Account Settings{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'users/auth-modal.css' %}">
  <link rel="stylesheet" href="{% static 'users/profile.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="profile-shell" data-collapsed-offset="sidebar">
  <div class="profile-content">
    <div class="profile-hero">
      <h1 class="profile-hero-title">Account Settings</h1>
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input id="profile_img" name="profile_img" type="file" accept=".png,.jpg,.jpeg,image/png,image/jpeg" class="profile-file-input">

        <section class="profile-card profile-card-info">
          <h2 class="profile-card-title">Account Information</h2>
          <div class="profile-avatar-row">
            <label class="profile-avatar" for="profile_img" aria-label="Upload avatar">
              {% if profile.profile_img %}
                <img id="profile-avatar-preview" src="{% url 'users:avatar' profile.uuid %}?v={{ profile.profile_img.name }}" alt="Profile avatar">
                <span id="profile-avatar-fallback" class="profile-avatar-fallback hidden" aria-hidden="true"></span>
              {% else %}
                <img id="profile-avatar-preview" src="{% static 'images/avatar.png' %}" alt="Default avatar">
                <span id="profile-avatar-fallback" class="profile-avatar-fallback hidden" aria-hidden="true"></span>
              {% endif %}
            </label>
            <p class="profile-avatar-text">Update your avatar by clicking the image</p>
          </div>
          <div class="profile-grid">
            <div class="profile-field-narrow">
              <label class="profile-label" for="display_name">Display name</label>
              <input id="display_name" name="display_name" type="text" value="{{ display_name }}" class="profile-input" maxlength="80" required>
            </div>
          </div>
          <button type="submit" name="save_account" value="1" class="profile-primary-button">Save changes</button>
          {% if account_error and request.POST.save_account %}
            <p class="profile-error">{{ account_error }}</p>
          {% endif %}
          {% if success and request.POST.save_account %}
            <p class="profile-success">Your profile has been updated.</p>
          {% endif %}
        </section>

        <section class="profile-card profile-card-account">
          <h2 class="profile-card-title">Security</h2>
          <div class="profile-security">
            <div class="profile-security-row">
              <div class="profile-email-field">
                <label class="profile-label" for="username_security">Username</label>
                <div class="profile-email-input-row">
                  <input id="username_security" class="profile-input profile-input-disabled" type="text" value="{{ username }}" readonly tabindex="-1">
                </div>
              </div>
            </div>
            <div class="profile-security-row">
              <div class="profile-email-field">
                <label class="profile-label" for="email">Email</label>
                <div class="profile-email-input-row">
                  <input id="email" name="email" class="profile-input profile-input-disabled" type="email" value="{{ email }}" readonly tabindex="-1">
                </div>
              </div>
            </div>
            <div class="profile-security-row">
              <div>
                <label class="profile-label">Password</label>
                <div class="profile-password-field">
                  <span class="profile-password-text">..............</span>
                </div>
              </div>
              <div class="security-action">
                <span id="password-update-message" class="profile-inline-success hidden">Your password has been updated.</span>
                {% if has_usable_password %}
                  <button class="profile-secondary-button" type="button" id="open-password-modal">Change your password</button>
                {% else %}
                  <button class="profile-secondary-button" type="button" id="open-password-modal">Set password for email login</button>
                {% endif %}
              </div>
            </div>
          </div>
        </section>
      </form>
    </div>
  </div>
</div>

<dialog id="password-modal" class="profile-modal">
  <div id="password-modal-content" class="profile-modal__content">
    {% include "users/password_change_form.html" %}
  </div>
</dialog>
{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const fileInput = document.getElementById("profile_img");
      const preview = document.getElementById("profile-avatar-preview");
      const fallback = document.getElementById("profile-avatar-fallback");
      if (fileInput && preview && fallback) {
        fileInput.addEventListener("change", () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;
          preview.src = URL.createObjectURL(file);
          preview.classList.remove("hidden");
          fallback.classList.add("hidden");
        });
      }

      const modal = document.getElementById("password-modal");
      const content = document.getElementById("password-modal-content");
      const openBtn = document.getElementById("open-password-modal");
      const message = document.getElementById("password-update-message");
      if (!modal || !content || !openBtn) return;

      const loadPasswordForm = async () => {
        const response = await fetch("{% url 'users:password_change' %}", {
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });
        content.innerHTML = await response.text();
      };

      const bindModal = () => {
        const closeBtn = content.querySelector("#close-password-modal");
        if (closeBtn) {
          closeBtn.addEventListener("click", () => modal.close());
        }
        const form = content.querySelector("form");
        if (!form || form.dataset.bound) return;
        form.dataset.bound = "true";
        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          const response = await fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            headers: { "X-Requested-With": "XMLHttpRequest" },
          });
          if (response.ok) {
            if (message) {
              message.classList.remove("hidden");
            }
            openBtn.textContent = "Change your password";
            await loadPasswordForm();
            bindModal();
            modal.close();
            return;
          }
          content.innerHTML = await response.text();
          bindModal();
          modal.showModal();
        });
      };

      openBtn.addEventListener("click", async () => {
        if (message) {
          message.classList.add("hidden");
        }
        await loadPasswordForm();
        bindModal();
        modal.showModal();
      });
    });
  </script>
{% endblock %}
